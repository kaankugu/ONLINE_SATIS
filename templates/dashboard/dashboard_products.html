{% load static %}
<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <title>√úr√ºn Y√∂netimi</title>
    <link rel="stylesheet" href="{% static 'css/add_product.css' %}">
    <style>
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }

        .modal.open {
            display: flex;
        }

        .modal-content {
            max-height: 85vh;           /* ekranƒ±n %90'ƒ±nƒ± ge√ßmesin */
            overflow-y: auto;           /* i√ßerik ta≈üarsa kaydƒ±r */
            padding-right: 16px; 
            background: #fff;
            padding: 30px;
            border-radius: 12px;
            width: 100%;
            max-width: 600px;
            margin-top:80px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            animation: slideDown 0.3s ease;
        }


        @keyframes slideDown {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Filters & bulk */
        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 20px 0;
        }

        .controls>* {
            padding: 8px;
        }

        .bulk-actions button {
            margin-right: 8px;
        }

        /* Table */
        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            border: 1px solid #ccc;
            padding: 8px;
        }

        th {
            background: #f9f9f9;
        }

        .action-btn {
            margin-top: 10px;
            cursor: pointer;
            margin-right: 6px;
        }
    </style>
</head>

<body>
    {% include 'menu.html' %}

    <section class="container">
        <h1>√úr√ºn Y√∂netimi</h1>
        <button id="openAddBtn" class="toggle-btn">+ Yeni √úr√ºn</button>

        <!-- Filtre ve Bulk -->
        <div class="controls">
            <input type="text" id="searchTitle" class="dashboard-input" placeholder="Ba≈ülƒ±k ara‚Ä¶">
            <select id="filterType">
                <option value="">T√ºm T√ºrler</option>
                <option value="tabak">Tabak</option>
                <option value="kase">Kase</option>
                <option value="karo">Karo</option>
                <option value="vazo">Vazo</option>
                <option value="diƒüer">Diƒüer</option>
            </select>
            <select id="filterStatus">
                <option value="">T√ºm Durumlar</option>
                <option value="true">Aktif</option>
                <option value="false">Pasif</option>
            </select>

            <div class="bulk-actions">
                <button id="bulkActivate">Toplu Aktifle≈ütir</button>
                <button id="bulkDeactivate">Toplu Pasifle≈ütir</button>
                <button id="bulkDelete">Toplu Sil</button>
            </div>
        </div>

        <!-- √úr√ºn Tablosu -->
        <table id="productTable">
            <thead>
                <tr>
                    <th><input type="checkbox" id="selectAll" /></th>
                    <th>ID</th>
                    <th>G√∂rsel</th>
                    <th>Ba≈ülƒ±k</th>
                    <th>Fiyat</th>
                    <th>T√ºr</th>
                    <th>Durum</th>
                    <th>ƒ∞≈ülemler</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </section>

    <!-- Modal: Ekle / D√ºzenle -->
    <div id="form-mode-note" style="font-size:13px;color:#777;margin-bottom:10px;">Yeni √ºr√ºn eklemek √ºzeresiniz.</div>
    <div id="productModal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle">Yeni √úr√ºn</h2>
            <form id="modalForm" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="form-group">
                    <label>Ba≈ülƒ±k</label>
                    <input type="text" name="title" id="m_title" required />
                </div>
                <div class="form-group">
                    <label>T√ºr</label>
                    <select name="type" id="m_type" required>
                        <option value="">Se√ßiniz</option>
                        <option value="tabak">Tabak</option>
                        <option value="kase">Kase</option>
                        <option value="karo">Karo</option>
                        <option value="vazo">Vazo</option>
                        <option value="diƒüer">Diƒüer</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>A√ßƒ±klama</label>
                    <textarea name="description" id="m_description" required style="height: 80px;"></textarea>
                </div>
                <div class="form-group">
                    <label>Fiyat</label>
                    <input type="number" name="price" id="m_price" step="0.01" required />
                </div>
                <div class="form-group">
                    <label>Durum</label>
                    <select name="permission" id="m_permission">
                        <option value="true">Aktif</option>
                        <option value="false">Pasif</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Resimler</label>
                    <input type="file" id="m_images" multiple accept="image/*" />
                </div>
                <div id="m_preview" style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px;"></div>

                <button type="submit" class="submit-btn" style="margin-top: 20px;">Kaydet</button>
                <button type="button" id="closeModal" class="submit-btn"
                    style="background:#ccc;color:#000;margin-top: 20px;">ƒ∞ptal</button>
            </form>
        </div>
    </div>

    <!-- JS -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        // API URL‚Äôleri
        const API_LIST = "/dashboard/products/";
        const API_CREATE = "/dashboard/products/";
        const API_DETAIL = id => `/dashboard/products/${id}/`;

        let products = [], // t√ºm √ºr√ºnler
            filtered = [],
            editId = null,
            fileList = [];

        function hideModal() {
            $('#productModal').removeClass('open');
        }

        $(function () {
            // Modal a√ß/kapa
            $('#openAddBtn').click(() => showModal());
            $('#closeModal').click(() => hideModal());

            // Filtre olaylarƒ±
            $('#searchTitle, #filterType, #filterStatus').on('input change', applyFilter);

            // Bulk action
            $('#selectAll').on('change', function () {
                $('tbody input.row-select').prop('checked', this.checked);
            });
            $('#bulkActivate').click(() => bulkUpdate('true'));
            $('#bulkDeactivate').click(() => bulkUpdate('false'));
            $('#bulkDelete').click(bulkDelete);

            // Modal form submit
            $('#modalForm').submit(e => {
                e.preventDefault();
                const btn = $('.submit-btn').first();
                btn.text(editId ? 'G√ºncelleniyor...' : 'Kaydediliyor...');
                editId ? updateProduct(editId) : createProduct();
            });

            // Resim preview
            $('#m_images').change(e => {
                fileList = Array.from(e.target.files);
                $('#m_preview').empty();
                fileList.forEach(f => {
                    const img = URL.createObjectURL(f);
                    $('#m_preview').append(`<img src="${img}" style="max-width:60px;border:1px solid #ccc;">`);
                });
            });

            // ƒ∞lk veri √ßek
            fetchProducts();
        });

        // Veri √ßek ve render et
        function fetchProducts() {
            $.get(API_LIST, data => {
                products = data;
                filtered = products;
                renderTable(filtered);
            });
        }

        function renderTable(arr) {
            const rows = arr.map(p => `
        <tr>
          <td><input type="checkbox" class="row-select" data-id="${p.id}"></td>
          <td>${p.id}</td>
          <td><img src="${p.images?.[0]?.image || '/static/images/default.png'}" style="width:60px;height:60px;object-fit:cover;"></td>
          <td>${p.title}</td>
          <td>${p.price}</td>
          <td>${p.type}</td>
          <td>${p.permission ? 'Aktif' : 'Pasif'}</td>
          <td>
            <span class="action-btn" onclick="startEdit(${p.id})">‚úèÔ∏è</span>
            <span class="action-btn" onclick="deleteOne(${p.id})">üóëÔ∏è</span>
          </td>
        </tr>
      `).join('');
            $('#productTable tbody').html(rows);
        }

        // Filtre uygula
        function applyFilter() {
            const tx = $('#searchTitle').val().toLowerCase();
            const ty = $('#filterType').val();
            const st = $('#filterStatus').val();
            filtered = products.filter(p => {
                return (!tx || p.title.toLowerCase().includes(tx))
                    && (!ty || p.type === ty)
                    && (!st || String(p.permission) === st);
            });
            renderTable(filtered);
        }

        // Modal g√∂ster
        function showModal(p) {
            if (!p) {
                editId = null;
                $('#modalTitle').text('Yeni √úr√ºn');
                $('#form-mode-note').text('Yeni √ºr√ºn eklemek √ºzeresiniz.');
                $('#modalForm')[0].reset();
                $('#m_preview').empty();
                fileList = [];
            } else {
                editId = p.id;
                $('#modalTitle').text('√úr√ºn D√ºzenle');
                $('#form-mode-note').text('Bu √ºr√ºn√º d√ºzenliyorsunuz.');
                $('#m_title').val(p.title);
                $('#m_type').val(p.type);
                $('#m_description').val(p.description);
                $('#m_price').val(p.price);
                $('#m_permission').val(String(p.permission));
                $('#m_preview').empty();
                fileList = [];
            }
            $('#productModal').addClass('open');
        }


        // Yeni √ºr√ºn
        function createProduct() {
            const fd = new FormData();
            fd.append('title', $('#m_title').val());
            fd.append('type', $('#m_type').val());
            fd.append('description', $('#m_description').val());
            fd.append('price', $('#m_price').val());
            fd.append('permission', $('#m_permission').val());
            fileList.forEach(f => fd.append('images', f));
            $.ajax({
                url: API_CREATE,
                type: 'POST',
                data: fd,
                processData: false,
                contentType: false,
                xhrFields: { withCredentials: true }, // ‚Üê JWT g√∂nderilir
                success: () => {
                    hideModal();
                    $('.submit-btn').first().text('Kaydet');  // ‚Üê bu satƒ±r eksikse hep kalƒ±r
                    fetchProducts();
                },
                error: err => alert('Ekleme Hatasƒ±')
            });
        }

        // D√ºzenlemeyi ba≈ülat
        function startEdit(id) {
            const p = products.find(x => x.id === id);
            if (!p) return;

            showModal(p);  // modalƒ± a√ß

            $('#m_title').val(p.title);
            $('#m_type').val(p.type);
            $('#m_description').val(p.description);
            $('#m_price').val(p.price);
            $('#m_permission').val(String(p.permission));

            $('#m_preview').empty(); // √∂nce temizle

            if (p?.images?.length) {
                p.images.forEach(img => {
                    $('#m_preview').append(`
                        <div style="position:relative">
                            <img src="${img.image}" style="width:60px;height:60px;object-fit:cover;border:1px solid #ccc;">
                            <span onclick="deleteImage(${img.id})"
                                style="position:absolute;top:-6px;right:-6px;cursor:pointer;background:#f00;color:#fff;border-radius:50%;padding:0 5px;font-size:12px;">√ó</span>
                        </div>
                    `);
                });
            }

            fileList = [];  // en sona al
        }

        // G√ºncelle
        function updateProduct(id) {
            const fd = new FormData();
            fd.append('title', $('#m_title').val());
            fd.append('type', $('#m_type').val());
            fd.append('description', $('#m_description').val());
            fd.append('price', $('#m_price').val());
            fd.append('permission', $('#m_permission').val());
            fileList.forEach(f => fd.append('images', f));

            $.ajax({
                url: API_DETAIL(id),
                type: 'PUT',
                data: fd,
                processData: false,
                contentType: false,
                xhrFields: { withCredentials: true },
                headers: {
                    'X-HTTP-Method-Override': 'PUT'
                },
                success: (data) => {
                    console.log("‚úÖ G√ºncelleme ba≈üarƒ±lƒ±:", data);
                    $('.submit-btn').first().text('Kaydet');
                    hideModal();
                    fetchProducts();
                },
                error: (xhr) => {
                    console.log("‚ùå G√ºncelleme hatasƒ±:", xhr.status, xhr.responseText);
                    $('.submit-btn').first().text('Kaydet');
                    alert('G√ºncelleme sƒ±rasƒ±nda bir hata olu≈ütu.');
                }
            });
        }

        // Tek sil
        function deleteOne(id) {
            if (!confirm('Silinsin mi?')) return;
            $.ajax({
                url: API_DETAIL(id),
                type: 'DELETE',
                xhrFields: { withCredentials: true }, // ‚Üê bu ≈üart
                success: (data) => {
                    console.log("‚úÖ G√ºncelleme ba≈üarƒ±lƒ±:", data);
                    $('.submit-btn').first().text('Kaydet');
                    hideModal();
                    fetchProducts();
                },
                error: (xhr) => {
                    console.log("‚ùå G√ºncelleme hatasƒ±:", xhr.status, xhr.responseText);
                    $('.submit-btn').first().text('Kaydet');
                    alert('G√ºncelleme sƒ±rasƒ±nda bir hata olu≈ütu.');
                }
            });
        }

        // Bulk g√ºncelle
        function bulkUpdate(val) {
            const ids = $('.row-select:checked').map((i, el) => el.dataset.id).get();
            ids.forEach(id => {
                $.ajax({
                    url: API_DETAIL(id),
                    type: 'PATCH',
                    headers: {
                        'X-CSRFToken': $('input[name=csrfmiddlewaretoken]').val()
                    },
                    data: { permission: val },
                    success: () => fetchProducts()
                    });
            });
        }

        // Bulk sil
        function bulkDelete() {
            if (!confirm('Se√ßilenler silinsin mi?')) return;
            $('.row-select:checked').each((i, el) => {
                const id = el.dataset.id;
                $.ajax({
                    url: API_DETAIL(id), type: 'DELETE',
                    headers: { 'X-CSRFToken': $('input[name=csrfmiddlewaretoken]').val() },
                    success: () => fetchProducts()
                });
            });
        }

        function deleteImage(imageId) {
            if (!confirm("Bu resmi silmek istediƒüine emin misin?")) return;

            $.ajax({
                url: `/dashboard/product-images/${imageId}/`, // üîÅ bunu backend‚Äôde yazmalƒ±sƒ±n
                type: 'DELETE',
                xhrFields: { withCredentials: true },
                success: () => {
                fetchProducts();
                hideModal(); // refresh i√ßin
                },
                error: () => alert("Resim silinemedi.")
            });
            }

    </script>
</body>

</html>